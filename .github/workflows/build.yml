name: Build APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install Capacitor
      run: |
        npm init -y
        npm install @capacitor/core @capacitor/cli @capacitor/android
    
    - name: Setup www folder
      run: |
        mkdir -p www
        cp index.html www/
        cp sw.js www/
        cp manifest.json www/
        cp icon-192.png www/ || true
        cp icon-512.png www/ || true
    
    - name: Initialize Capacitor
      run: npx cap init CryptVault com.potatameister.cryptvault --web-dir www
    
    - name: Add Android
      run: npx cap add android
    
    - name: Fix Kotlin Conflict
      run: |
        cat >> android/app/build.gradle << 'EOF'
        
        configurations.all {
            resolutionStrategy {
                force 'org.jetbrains.kotlin:kotlin-stdlib:1.9.22'
                force 'org.jetbrains.kotlin:kotlin-stdlib-jdk7:1.9.22'
                force 'org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.9.22'
            }
        }
        EOF
    
    - name: Fix Status Bar (Solid Color)
      run: |
        # Create solid status bar style (not transparent)
        cat > android/app/src/main/res/values/styles.xml << 'STYLE'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <style name="AppTheme" parent="Theme.AppCompat.DayNight.NoActionBar">
                <item name="android:statusBarColor">#0f172a</item>
                <item name="android:navigationBarColor">#0f172a</item>
                <item name="android:windowDrawsSystemBarBackgrounds">true</item>
                <item name="android:windowLightStatusBar">false</item>
            </style>
            <style name="AppTheme.NoActionBar" parent="AppTheme">
                <item name="windowActionBar">false</item>
                <item name="windowNoTitle">true</item>
                <item name="android:statusBarColor">#0f172a</item>
            </style>
            <style name="AppTheme.NoActionBarLaunch" parent="AppTheme.NoActionBar">
                <item name="android:background">@drawable/splash</item>
            </style>
        </resources>
        STYLE
        
        # Also update colors.xml
        cat > android/app/src/main/res/values/colors.xml << 'COLORS'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <color name="colorPrimary">#0f172a</color>
            <color name="colorPrimaryDark">#0f172a</color>
            <color name="colorAccent">#6366f1</color>
        </resources>
        COLORS
    
    - name: Copy App Icons
      run: |
        if [ -f "icon-192.png" ]; then
          for folder in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
            cp icon-192.png android/app/src/main/res/mipmap-$folder/ic_launcher.png || true
            cp icon-192.png android/app/src/main/res/mipmap-$folder/ic_launcher_round.png || true
            cp icon-192.png android/app/src/main/res/mipmap-$folder/ic_launcher_foreground.png || true
          done
        fi
    
    - name: Sync
      run: npx cap sync
    
    - name: Build Release APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleRelease --no-daemon
    
    - name: Upload Unsigned Release APK
      uses: actions/upload-artifact@v4
      with:
        name: CryptVault-v1.5.0-unsigned
        path: android/app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 90
